@page "/country-compare"
@using System.Diagnostics
@using System.Diagnostics.Metrics
@rendermode InteractiveServer
@using BlazorApp.Models
@using BlazorApp.Services
@inject CountryComparisonService ComparisonService
@inject ILogger<CountryCompare> Logger

<PageTitle>Country Comparison Game</PageTitle>

<h1>ğŸŒ Country Comparison Game</h1>

<div class="score-display mb-3">
    <span class="badge bg-primary fs-6 me-2">
        Score: @ComparisonService.Score.CorrectAnswers / @ComparisonService.Score.TotalQuestions
        @if (ComparisonService.Score.TotalQuestions > 0)
        {
            <span>(@ComparisonService.Score.PercentageCorrect.ToString("F0")%)</span>
        }
    </span>
    @if (ComparisonService.Score.CurrentStreak > 1)
    {
        <span class="badge bg-warning text-dark fs-6 me-2">ğŸ”¥ @ComparisonService.Score.CurrentStreak streak</span>
    }
    @if (ComparisonService.Score.BestStreak > 1)
    {
        <span class="badge bg-secondary fs-6">Best: @ComparisonService.Score.BestStreak</span>
    }
    <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="ResetGame">Reset</button>
</div>

@if (_noDataAvailable)
{
    <div class="alert alert-warning">
        <strong>No data available</strong> for this question type. Please select a different question.
    </div>
}
else if (_currentQuestion is not null && _country1 is not null && _country2 is not null)
{
    <div class="question-section mb-4">
        <h3 class="text-center">@_currentQuestion.QuestionTemplate</h3>
        <p class="text-center text-muted small">
            @ComparisonService.GetCountryCountForQuestion(_currentQuestion) countries have data for this question
        </p>
    </div>
    
    <div class="row">
        <div class="col-md-5">
            <div class="card country-card @GetCardClass(_country1)" @onclick="() => SelectCountry(_country1)">
                @if (_hasAnswered && _lastResult?.CorrectAnswer == _country1)
                {
                    <span class="correct-indicator">âœ“ Correct</span>
                }
                <div class="card-body text-center">
                    <div class="flag-display mb-3">@_country1.FlagEmoji</div>
                    <h4 class="card-title">@_country1.Name</h4>
                    <p class="text-muted small mb-2">@_country1.Continent</p>
                    @if (_hasAnswered)
                    {
                        <p class="stat-reveal">@_currentQuestion.GetFormattedValue(_country1)</p>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-2 d-flex align-items-center justify-content-center">
            <span class="vs-text">VS</span>
        </div>
        
        <div class="col-md-5">
            <div class="card country-card @GetCardClass(_country2)" @onclick="() => SelectCountry(_country2)">
                @if (_hasAnswered && _lastResult?.CorrectAnswer == _country2)
                {
                    <span class="correct-indicator">âœ“ Correct</span>
                }
                <div class="card-body text-center">
                    <div class="flag-display mb-3">@_country2.FlagEmoji</div>
                    <h4 class="card-title">@_country2.Name</h4>
                    <p class="text-muted small mb-2">@_country2.Continent</p>
                    @if (_hasAnswered)
                    {
                        <p class="stat-reveal">@_currentQuestion.GetFormattedValue(_country2)</p>
                    }
                </div>
            </div>
        </div>
    </div>
    
    @if (_hasAnswered && _lastResult is not null)
    {
        <div class="result-section text-center mt-4">
            <div class="alert @(_lastResult.IsCorrect ? "alert-success" : "alert-danger")">
                @if (_lastResult.IsCorrect)
                {
                    <strong>Correct!</strong>
                }
                else
                {
                    <strong>Wrong!</strong>
                    <span>The answer was @_lastResult.CorrectAnswer.Name (@_lastResult.CorrectAnswer.FlagEmoji).</span>
                }
            </div>
            <button class="btn btn-primary btn-lg" @onclick="NextRound">Next Question</button>
        </div>
    }
    else
    {
        <p class="text-center mt-4 text-muted">Click on a country to make your choice!</p>
    }
}

<div class="mt-5">
    <details>
        <summary><h5 class="d-inline">Question Types</h5></summary>
        <div class="question-buttons mt-2" role="group">
            @foreach (var q in ComparisonService.AvailableQuestions)
            {
                <button type="button" 
                        class="btn btn-sm @(q == _currentQuestion ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => SetQuestion(q)">
                    @GetShortQuestionName(q.Id)
                </button>
            }
            <button type="button" 
                    class="btn btn-sm @(_randomMode ? "btn-warning" : "btn-outline-warning")"
                    @onclick="ToggleRandomMode">
                ğŸ² Random
            </button>
        </div>
    </details>
</div>

@code {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPENTELEMETRY INSTRUMENTATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ActivitySource for distributed tracing (spans)
    private static readonly ActivitySource ActivitySource = new("BlazorApp.CountryCompare", "1.0.0");

    // Meter for metrics
    private static readonly Meter Meter = new("BlazorApp.CountryCompare", "1.0.0");

    // â”€â”€ Counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    private static readonly Counter<long> RoundCounter = Meter.CreateCounter<long>(
        "countrycompare.rounds",
        unit: "{rounds}",
        description: "Total number of comparison rounds started");

    private static readonly Counter<long> AnswerCounter = Meter.CreateCounter<long>(
        "countrycompare.answers",
        unit: "{answers}",
        description: "Total number of answers submitted");

    private static readonly Counter<long> CorrectAnswerCounter = Meter.CreateCounter<long>(
        "countrycompare.correct_answers",
        unit: "{answers}",
        description: "Total number of correct answers");

    private static readonly Counter<long> WrongAnswerCounter = Meter.CreateCounter<long>(
        "countrycompare.wrong_answers",
        unit: "{answers}",
        description: "Total number of wrong answers");

    private static readonly Counter<long> ResetCounter = Meter.CreateCounter<long>(
        "countrycompare.resets",
        unit: "{resets}",
        description: "Total number of game resets");

    private static readonly Counter<long> QuestionTypeChangeCounter = Meter.CreateCounter<long>(
        "countrycompare.question_type_changes",
        unit: "{changes}",
        description: "Number of times question type was changed");

    private static readonly Counter<long> NoDataCounter = Meter.CreateCounter<long>(
        "countrycompare.no_data_events",
        unit: "{events}",
        description: "Number of times no data was available for a question");

    // â”€â”€ Histograms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    private static readonly Histogram<int> StreakHistogram = Meter.CreateHistogram<int>(
        "countrycompare.streak_length",
        unit: "{streak}",
        description: "Distribution of streak lengths when broken");

    // â”€â”€ Gauges (via UpDownCounter for current state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    private static readonly UpDownCounter<int> CurrentScoreGauge = Meter.CreateUpDownCounter<int>(
        "countrycompare.current_score",
        unit: "{score}",
        description: "Current score (correct answers)");

    private static readonly UpDownCounter<int> CurrentStreakGauge = Meter.CreateUpDownCounter<int>(
        "countrycompare.current_streak",
        unit: "{streak}",
        description: "Current winning streak");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPONENT STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private CountryData? _country1;
    private CountryData? _country2;
    private CountryComparisonQuestion? _currentQuestion;
    private CountryComparisonResult? _lastResult;
    private bool _hasAnswered;
    private bool _randomMode = true;
    private bool _noDataAvailable;

    protected override void OnInitialized()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.Initialize");
        Logger.LogInformation("Country Comparison Game initialized");
        StartNewRound();
    }

    private void StartNewRound()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.StartNewRound");
        
        _noDataAvailable = false;
        
        if (_randomMode)
        {
            _currentQuestion = ComparisonService.GetRandomViableQuestion();
        }
        else
        {
            _currentQuestion ??= ComparisonService.AvailableQuestions[0];
        }
        
        var pair = ComparisonService.GetRandomCountryPair(_currentQuestion);
        if (pair is null)
        {
            _noDataAvailable = true;
            NoDataCounter.Add(1, new KeyValuePair<string, object?>("question.type", _currentQuestion?.Id));
            
            activity?.SetTag("error", "no_data_available");
            activity?.SetTag("question.type", _currentQuestion?.Id);
            activity?.SetStatus(ActivityStatusCode.Error, "No data available for question");
            
            Logger.LogWarning("No data available for question type: {QuestionType}", _currentQuestion?.Id);
            return;
        }
        
        (_country1, _country2) = pair.Value;
        _hasAnswered = false;
        _lastResult = null;

        // Record metrics
        RoundCounter.Add(1);
        
        activity?.SetTag("country1.name", _country1.Name);
        activity?.SetTag("country1.continent", _country1.Continent);
        activity?.SetTag("country2.name", _country2.Name);
        activity?.SetTag("country2.continent", _country2.Continent);
        activity?.SetTag("question.type", _currentQuestion?.Id);
        activity?.SetTag("mode", _randomMode ? "random" : "fixed");
        
        Logger.LogInformation(
            "New round started: {Country1} ({Continent1}) vs {Country2} ({Continent2}), Question: {QuestionType}",
            _country1.Name, _country1.Continent, _country2.Name, _country2.Continent, _currentQuestion?.Id);
    }

    private void SelectCountry(CountryData selected)
    {
        if (_hasAnswered || _currentQuestion is null || _country1 is null || _country2 is null) 
            return;
        
        using var activity = ActivitySource.StartActivity("CountryCompare.SelectCountry");
        activity?.SetTag("selected.country", selected.Name);
        activity?.SetTag("selected.continent", selected.Continent);
        
        var previousStreak = ComparisonService.Score.CurrentStreak;
        _lastResult = ComparisonService.CheckAnswer(_country1, _country2, _currentQuestion, selected);
        _hasAnswered = true;

        // Record metrics
        AnswerCounter.Add(1, 
            new KeyValuePair<string, object?>("question.type", _currentQuestion.Id),
            new KeyValuePair<string, object?>("continent", selected.Continent ?? "Unknown"));
        
        if (_lastResult.IsCorrect)
        {
            CorrectAnswerCounter.Add(1, 
                new KeyValuePair<string, object?>("question.type", _currentQuestion.Id),
                new KeyValuePair<string, object?>("continent", selected.Continent ?? "Unknown"));
            CurrentScoreGauge.Add(1);
            CurrentStreakGauge.Add(1);
            
            activity?.SetTag("result", "correct");
            Logger.LogInformation(
                "Correct answer! Selected: {Selected}, Question: {QuestionType}, Score: {Score}/{Total}, Streak: {Streak}",
                selected.Name, _currentQuestion.Id, 
                ComparisonService.Score.CorrectAnswers, ComparisonService.Score.TotalQuestions,
                ComparisonService.Score.CurrentStreak);
        }
        else
        {
            WrongAnswerCounter.Add(1, 
                new KeyValuePair<string, object?>("question.type", _currentQuestion.Id),
                new KeyValuePair<string, object?>("continent", selected.Continent ?? "Unknown"));
            
            // Record broken streak if it was > 0
            if (previousStreak > 0)
            {
                StreakHistogram.Record(previousStreak);
                CurrentStreakGauge.Add(-previousStreak); // Reset streak gauge
            }
            
            activity?.SetTag("result", "wrong");
            activity?.SetTag("correct.answer", _lastResult.CorrectAnswer.Name);
            activity?.SetTag("streak.broken", previousStreak);
            
            Logger.LogInformation(
                "Wrong answer. Selected: {Selected}, Correct: {Correct}, Question: {QuestionType}, Streak broken: {Streak}",
                selected.Name, _lastResult.CorrectAnswer.Name, _currentQuestion.Id, previousStreak);
        }
        
        activity?.SetStatus(ActivityStatusCode.Ok);
    }

    private void NextRound() => StartNewRound();

    private void ResetGame()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.ResetGame");
        
        var finalScore = ComparisonService.Score.CorrectAnswers;
        var totalQuestions = ComparisonService.Score.TotalQuestions;
        var bestStreak = ComparisonService.Score.BestStreak;
        
        // Reset gauges to 0
        CurrentScoreGauge.Add(-finalScore);
        CurrentStreakGauge.Add(-ComparisonService.Score.CurrentStreak);
        
        ComparisonService.Score.Reset();
        ResetCounter.Add(1);
        
        activity?.SetTag("final.score", finalScore);
        activity?.SetTag("final.total", totalQuestions);
        activity?.SetTag("final.best_streak", bestStreak);
        activity?.SetTag("final.percentage", totalQuestions > 0 ? (double)finalScore / totalQuestions * 100 : 0);
        
        Logger.LogInformation(
            "Game reset. Final score: {Score}/{Total} ({Percentage:F1}%), Best streak: {BestStreak}",
            finalScore, totalQuestions, 
            totalQuestions > 0 ? (double)finalScore / totalQuestions * 100 : 0,
            bestStreak);
        
        StartNewRound();
    }

    private void SetQuestion(CountryComparisonQuestion question)
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.SetQuestion");
        
        var previousQuestion = _currentQuestion?.Id;
        _randomMode = false;
        _currentQuestion = question;
        
        QuestionTypeChangeCounter.Add(1, 
            new KeyValuePair<string, object?>("from", previousQuestion ?? "none"),
            new KeyValuePair<string, object?>("to", question.Id));
        
        activity?.SetTag("previous.question", previousQuestion);
        activity?.SetTag("new.question", question.Id);
        activity?.SetTag("countries_with_data", ComparisonService.GetCountryCountForQuestion(question));
        
        Logger.LogInformation(
            "Question type changed from {Previous} to {New} ({CountryCount} countries with data)", 
            previousQuestion, question.Id, ComparisonService.GetCountryCountForQuestion(question));
        
        StartNewRound();
    }

    private void ToggleRandomMode()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.ToggleRandomMode");
        
        _randomMode = true;
        
        activity?.SetTag("mode", "random");
        Logger.LogInformation("Switched to random question mode");
        
        StartNewRound();
    }

    private string GetCardClass(CountryData country)
    {
        if (!_hasAnswered) return "clickable";
        if (_lastResult is null) return "";
        
        if (country == _lastResult.CorrectAnswer)
            return "correct-answer";
        if (country == _lastResult.UserChoice && !_lastResult.IsCorrect)
            return "wrong-answer";
        return "";
    }
    
    private string GetShortQuestionName(string id) => id switch
    {
        "population" => "Population",
        "area" => "Area",
        "gdp" => "GDP",
        "gdp_per_capita" => "GDP/capita",
        "gni_ppp" => "GNI PPP",
        "density" => "Density",
        "literacy" => "Literacy",
        "hdi" => "HDI",
        "life_expectancy" => "Life Exp.",
        _ => id
    };
}
