@page "/country-compare"
@rendermode InteractiveServer
@using BlazorApp.Models
@using BlazorApp.Services
@using System.Diagnostics
@using System.Diagnostics.Metrics
@using System.Text.Json
@inject CountryComparisonService ComparisonService
@inject ILogger<CountryCompare> Logger
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>World Country Comparison</PageTitle>

<div class="game-container">
    <h1 class="game-title">ğŸŒ Country Comparison</h1>

    <div class="score-display">
        <span class="score">Score: @ComparisonService.Score.CorrectAnswers/@ComparisonService.Score.TotalQuestions</span>
        @if (ComparisonService.Score.CurrentStreak > 0)
        {
            <span class="streak">ğŸ”¥ @ComparisonService.Score.CurrentStreak streak</span>
        }
        @if (ComparisonService.Score.BestStreak > 0)
        {
            <span class="best-streak">â­ Best: @ComparisonService.Score.BestStreak</span>
        }
    </div>

    @if (_noDataAvailable)
    {
        <div class="alert alert-warning">
            Not enough countries with data for this question type. Please select another.
        </div>
    }
    else if (_currentQuestion != null && _country1 != null && _country2 != null)
    {
        <p class="question-text">@_currentQuestion.QuestionTemplate</p>

        <div class="comparison-container">
            <div class="comparison-card @GetCardClass(_country1)" @onclick="() => SelectCountry(_country1)">
                <div class="country-flag">@_country1.FlagEmoji</div>
                <div class="country-name">@_country1.Name</div>
                @if (_hasAnswered)
                {
                    <div class="value-reveal">@FormatValue(_country1)</div>
                }
            </div>

            <div class="vs-badge">VS</div>

            <div class="comparison-card @GetCardClass(_country2)" @onclick="() => SelectCountry(_country2)">
                <div class="country-flag">@_country2.FlagEmoji</div>
                <div class="country-name">@_country2.Name</div>
                @if (_hasAnswered)
                {
                    <div class="value-reveal">@FormatValue(_country2)</div>
                }
            </div>
        </div>

        @if (_hasAnswered && _lastResult != null)
        {
            <div class="result-message @(_lastResult.IsCorrect ? "correct" : "wrong")">
                @(_lastResult.IsCorrect ? "âœ“ Correct!" : "âœ— Wrong!")
            </div>
            <button class="btn btn-primary next-btn" @onclick="StartNewRound">Next â†’</button>
        }
    }

    <div class="controls mt-3">
        <button class="btn btn-sm @(_randomMode ? "btn-primary" : "btn-outline-primary")" @onclick="ToggleRandomMode">
            ğŸ² Random
        </button>
        @foreach (var q in ComparisonService.Questions)
        {
            var count = ComparisonService.GetCountryCountForQuestion(q);
            <button class="btn btn-sm @(_currentQuestion?.Id == q.Id && !_randomMode ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => SetQuestion(q)"
                    disabled="@(count < 2)">
                @GetShortQuestionName(q.Id)
                <span class="badge bg-secondary ms-1">@count</span>
            </button>
        }
        <button class="btn btn-sm btn-outline-danger ms-2" @onclick="ResetGame">Reset</button>
    </div>

    @if (_persistedStats != null)
    {
        <div class="lifetime-stats mt-3">
            <small class="text-muted">
                Lifetime: @_persistedStats.TotalCorrect/@_persistedStats.TotalQuestions
                (@(_persistedStats.TotalQuestions > 0 ? $"{(double)_persistedStats.TotalCorrect / _persistedStats.TotalQuestions:P0}" : "N/A"))
                | Best Streak: @_persistedStats.BestStreak
                <button class="btn btn-link btn-sm p-0 ms-2" @onclick="ClearPersistedStats">Clear</button>
            </small>
        </div>
    }
</div>

@code {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOCAL STORAGE KEY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private const string LocalStorageKey = "HelloAspDotnetTen.CountryCompare.Stats";

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPENTELEMETRY INSTRUMENTATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private static readonly ActivitySource ActivitySource = new("BlazorApp.CountryCompare", "1.0.0");
    private static readonly Meter Meter = new("BlazorApp.CountryCompare", "1.0.0");

    private static readonly Counter<long> RoundCounter = Meter.CreateCounter<long>("countrycompare.rounds", "rounds", "Rounds started");
    private static readonly Counter<long> CorrectAnswerCounter = Meter.CreateCounter<long>("countrycompare.correct_answers", "answers", "Correct answers");
    private static readonly Counter<long> WrongAnswerCounter = Meter.CreateCounter<long>("countrycompare.wrong_answers", "answers", "Wrong answers");
    private static readonly Counter<long> ResetCounter = Meter.CreateCounter<long>("countrycompare.resets", "resets", "Game resets");
    private static readonly Counter<long> QuestionTypeChangeCounter = Meter.CreateCounter<long>("countrycompare.question_type_changes", "changes", "Question type changes");
    private static readonly Counter<long> NoDataEventCounter = Meter.CreateCounter<long>("countrycompare.no_data_events", "events", "No data available events");
    private static readonly Histogram<int> StreakHistogram = Meter.CreateHistogram<int>("countrycompare.streak_length", "streak", "Streak lengths when broken");
    private static readonly UpDownCounter<int> CurrentScoreGauge = Meter.CreateUpDownCounter<int>("countrycompare.current_score", "score", "Current score");
    private static readonly UpDownCounter<int> CurrentStreakGauge = Meter.CreateUpDownCounter<int>("countrycompare.current_streak", "streak", "Current streak");
    private static readonly Counter<long> LocalStorageLoadCounter = Meter.CreateCounter<long>("countrycompare.storage.loads", "operations", "Local storage loads");
    private static readonly Counter<long> LocalStorageSaveCounter = Meter.CreateCounter<long>("countrycompare.storage.saves", "operations", "Local storage saves");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private CountryData? _country1;
    private CountryData? _country2;
    private CountryComparisonQuestion? _currentQuestion;
    private CountryComparisonResult? _lastResult;
    private bool _hasAnswered;
    private bool _randomMode = true;
    private bool _noDataAvailable;
    private int _previousStreak;

    // Local storage state
    private ComparePersistedStats? _persistedStats;
    private bool _isJsRuntimeAvailable = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERSISTED STATS MODEL - INCLUDES SESSION STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private class ComparePersistedStats
    {
        // Lifetime stats
        public int TotalQuestions { get; set; }
        public int TotalCorrect { get; set; }
        public int BestStreak { get; set; }
        public DateTime FirstPlayedUtc { get; set; } = DateTime.UtcNow;
        public DateTime LastPlayedUtc { get; set; } = DateTime.UtcNow;

        // SESSION STATE - survives page reload
        public int SessionCorrect { get; set; }
        public int SessionTotal { get; set; }
        public int SessionCurrentStreak { get; set; }
        public int SessionBestStreak { get; set; }
        public bool RandomMode { get; set; } = true;
        public string? CurrentQuestionId { get; set; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LIFECYCLE METHODS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    protected override void OnInitialized()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.Initialize");
        Logger.LogInformation("Country Comparison Game initialized");
        StartNewRound();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isJsRuntimeAvailable = true;
            await LoadPersistedStatsAsync();
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_persistedStats != null && ComparisonService.Score.BestStreak > _persistedStats.BestStreak)
        {
            _persistedStats.BestStreak = ComparisonService.Score.BestStreak;
        }
        await SavePersistedStatsAsync();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOCAL STORAGE OPERATIONS - SAVE EVERYTHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private async Task LoadPersistedStatsAsync()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.LoadPersistedStats");

        try
        {
            var json = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", LocalStorageKey);

            if (!string.IsNullOrEmpty(json))
            {
                _persistedStats = JsonSerializer.Deserialize<ComparePersistedStats>(json);
                LocalStorageLoadCounter.Add(1, new KeyValuePair<string, object?>("storage.found", true));

                // RESTORE SESSION STATE
                if (_persistedStats != null)
                {
                    // Restore to ComparisonService.Score
                    for (int i = 0; i < _persistedStats.SessionCorrect; i++)
                    {
                        ComparisonService.Score.CorrectAnswers++;
                    }
                    for (int i = 0; i < _persistedStats.SessionTotal; i++)
                    {
                        ComparisonService.Score.TotalQuestions++;
                    }
                    ComparisonService.Score.CurrentStreak = _persistedStats.SessionCurrentStreak;
                    ComparisonService.Score.BestStreak = _persistedStats.SessionBestStreak;

                    // Restore UI state
                    _randomMode = _persistedStats.RandomMode;
                    if (!string.IsNullOrEmpty(_persistedStats.CurrentQuestionId))
                    {
                        _currentQuestion = ComparisonService.Questions.FirstOrDefault(q => q.Id == _persistedStats.CurrentQuestionId);
                    }

                    // Sync gauges
                    CurrentScoreGauge.Add(_persistedStats.SessionCorrect);
                    CurrentStreakGauge.Add(_persistedStats.SessionCurrentStreak);
                }

                Logger.LogInformation(
                    "Loaded CountryCompare stats: Lifetime={Total}/{Correct}, Session={SessionTotal}/{SessionCorrect}",
                    _persistedStats?.TotalQuestions ?? 0, _persistedStats?.TotalCorrect ?? 0,
                    _persistedStats?.SessionTotal ?? 0, _persistedStats?.SessionCorrect ?? 0);
            }
            else
            {
                _persistedStats = new ComparePersistedStats();
                await SavePersistedStatsAsync();
                LocalStorageLoadCounter.Add(1, new KeyValuePair<string, object?>("storage.found", false));
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load CountryCompare persisted stats");
            _persistedStats = new ComparePersistedStats();
        }
    }

    private async Task SavePersistedStatsAsync()
    {
        if (!_isJsRuntimeAvailable || _persistedStats == null) return;

        try
        {
            // SAVE SESSION STATE
            _persistedStats.SessionCorrect = ComparisonService.Score.CorrectAnswers;
            _persistedStats.SessionTotal = ComparisonService.Score.TotalQuestions;
            _persistedStats.SessionCurrentStreak = ComparisonService.Score.CurrentStreak;
            _persistedStats.SessionBestStreak = ComparisonService.Score.BestStreak;
            _persistedStats.RandomMode = _randomMode;
            _persistedStats.CurrentQuestionId = _currentQuestion?.Id;
            _persistedStats.LastPlayedUtc = DateTime.UtcNow;

            // Update lifetime best streak if needed
            if (ComparisonService.Score.BestStreak > _persistedStats.BestStreak)
            {
                _persistedStats.BestStreak = ComparisonService.Score.BestStreak;
            }

            var json = JsonSerializer.Serialize(_persistedStats);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", LocalStorageKey, json);
            LocalStorageSaveCounter.Add(1);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to save CountryCompare persisted stats");
        }
    }

    private async Task ClearPersistedStats()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", LocalStorageKey);

            // Reset gauges
            CurrentScoreGauge.Add(-ComparisonService.Score.CorrectAnswers);
            CurrentStreakGauge.Add(-ComparisonService.Score.CurrentStreak);

            ComparisonService.Score.Reset();
            _persistedStats = new ComparePersistedStats();
            StartNewRound();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to clear CountryCompare persisted stats");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private void StartNewRound()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.StartNewRound");

        _noDataAvailable = false;

        if (_randomMode)
        {
            _currentQuestion = ComparisonService.GetRandomViableQuestion();
        }
        else
        {
            _currentQuestion ??= ComparisonService.Questions.First();
        }

        if (_currentQuestion == null)
        {
            _noDataAvailable = true;
            NoDataEventCounter.Add(1);
            return;
        }

        // Get pair WITHOUT ties - prevents gotcha questions
        var pair = ComparisonService.GetRandomCountryPairWithoutTie(_currentQuestion);
        if (pair == null)
        {
            _noDataAvailable = true;
            NoDataEventCounter.Add(1);
            return;
        }

        (_country1, _country2) = pair.Value;
        _lastResult = null;
        _hasAnswered = false;
        RoundCounter.Add(1);

        activity?.SetTag("country1", _country1?.Name);
        activity?.SetTag("country2", _country2?.Name);
        activity?.SetTag("question", _currentQuestion?.Id);
    }

    private async Task SelectCountry(CountryData selectedCountry)
    {
        if (_hasAnswered || _currentQuestion == null || _country1 == null || _country2 == null) return;

        using var activity = ActivitySource.StartActivity("CountryCompare.SelectCountry");

        _previousStreak = ComparisonService.Score.CurrentStreak;

        _lastResult = ComparisonService.CheckAnswer(_country1, _country2, _currentQuestion, selectedCountry);
        _hasAnswered = true;

        // Update persisted lifetime stats
        if (_persistedStats != null)
        {
            _persistedStats.TotalQuestions++;
            if (_lastResult.IsCorrect)
            {
                _persistedStats.TotalCorrect++;
                CorrectAnswerCounter.Add(1);
                CurrentScoreGauge.Add(1);
                CurrentStreakGauge.Add(1);
            }
            else
            {
                WrongAnswerCounter.Add(1);
                if (_previousStreak > 0)
                {
                    StreakHistogram.Record(_previousStreak);
                    CurrentStreakGauge.Add(-_previousStreak);
                }
            }
        }

        activity?.SetTag("correct", _lastResult.IsCorrect);
        activity?.SetTag("streak", ComparisonService.Score.CurrentStreak);
        activity?.SetTag("continent", _country1.Continent);

        // Save immediately after every answer
        await SavePersistedStatsAsync();
    }

    private async Task ResetGame()
    {
        using var activity = ActivitySource.StartActivity("CountryCompare.ResetGame");

        var finalScore = ComparisonService.Score.CorrectAnswers;

        CurrentScoreGauge.Add(-finalScore);
        CurrentStreakGauge.Add(-ComparisonService.Score.CurrentStreak);

        ComparisonService.Score.Reset();

        // Reset session in persisted stats but keep lifetime
        if (_persistedStats != null)
        {
            _persistedStats.SessionCorrect = 0;
            _persistedStats.SessionTotal = 0;
            _persistedStats.SessionCurrentStreak = 0;
            _persistedStats.SessionBestStreak = 0;
        }

        ResetCounter.Add(1);

        await SavePersistedStatsAsync();
        StartNewRound();
    }

    private async Task SetQuestion(CountryComparisonQuestion question)
    {
        _randomMode = false;
        _currentQuestion = question;
        QuestionTypeChangeCounter.Add(1);
        StartNewRound();
        await SavePersistedStatsAsync();
    }

    private async Task ToggleRandomMode()
    {
        _randomMode = true;
        StartNewRound();
        await SavePersistedStatsAsync();
    }

    private string GetCardClass(CountryData country)
    {
        if (!_hasAnswered) return "clickable";
        if (_lastResult is null) return "";

        if (country == _lastResult.CorrectAnswer)
            return "correct-answer";
        if (country == _lastResult.UserChoice && !_lastResult.IsCorrect)
            return "wrong-answer";
        return "";
    }

    /// <summary>
    /// Custom formatting for GDP - NO "M" suffix. Shows B for billions, T for trillions.
    /// </summary>
    private string FormatValue(CountryData country)
    {
        if (_currentQuestion == null) return "N/A";

        var value = _currentQuestion.GetValue(country);
        if (!value.HasValue) return "N/A";

        // Special handling for GDP - stored in millions, display in billions/trillions
        if (_currentQuestion.Id == "gdp")
        {
            var billions = value.Value / 1000.0;
            if (billions >= 1000)
                return $"${billions / 1000:N2}T";
            else if (billions >= 1)
                return $"${billions:N1}B";
            else
                return $"${value.Value:N0}M";
        }

        // Special handling for GDP per capita - no "M", just dollars
        if (_currentQuestion.Id == "gdp_per_capita")
        {
            return $"${value.Value:N0}";
        }

        // Use default formatting for all other question types
        return _currentQuestion.GetFormattedValue(country);
    }

    private string GetShortQuestionName(string id) => id switch
    {
        "population" => "Pop",
        "area" => "Area",
        "gdp" => "GDP",
        "gdp_per_capita" => "GDP/cap",
        "gni_ppp" => "GNI",
        "density" => "Density",
        "literacy" => "Literacy",
        "hdi" => "HDI",
        "life_expectancy" => "Life",
        _ => id
    };
}
