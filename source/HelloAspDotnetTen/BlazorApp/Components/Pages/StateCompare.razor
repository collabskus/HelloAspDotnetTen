@page "/state-compare"
@using System.Diagnostics
@using System.Diagnostics.Metrics
@using System.Text.Json
@rendermode InteractiveServer
@using BlazorApp.Models
@using BlazorApp.Services
@inject StateComparisonService ComparisonService
@inject ILogger<StateCompare> Logger
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>State Comparison Game</PageTitle>

<h1 class="h3 mb-2">State Comparison Game</h1>

<div class="score-display mb-3">
    <span class="badge bg-primary fs-6">
        Score: @ComparisonService.Score.CorrectAnswers / @ComparisonService.Score.TotalQuestions
        @if (ComparisonService.Score.TotalQuestions > 0)
        {
            <span>(@ComparisonService.Score.PercentageCorrect.ToString("F0")%)</span>
        }
    </span>
    @if (ComparisonService.Score.CurrentStreak > 1)
    {
        <span class="badge bg-warning text-dark fs-6 ms-1">ğŸ”¥ @ComparisonService.Score.CurrentStreak streak</span>
    }
    @if (ComparisonService.Score.BestStreak > 1)
    {
        <span class="badge bg-secondary fs-6 ms-1">Best: @ComparisonService.Score.BestStreak</span>
    }
    <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="ResetGame">Reset</button>
</div>

@if (_currentQuestion is not null && _state1 is not null && _state2 is not null)
{
    <div class="question-section mb-3">
        <h3 class="text-center h5">@_currentQuestion.QuestionTemplate</h3>
    </div>

    <div class="comparison-container">
        <div class="comparison-card @GetCardClass(_state1)" @onclick="() => SelectState(_state1)">
            @if (_hasAnswered && _lastResult?.CorrectAnswer == _state1)
            {
                <span class="correct-indicator">âœ“</span>
            }
            <div class="card-content">
                <div class="state-abbrev">@_state1.Abbreviation</div>
                <h4 class="state-name">@_state1.Name</h4>
                @if (_hasAnswered)
                {
                    <p class="stat-reveal">@_currentQuestion.GetFormattedValue(_state1)</p>
                }
            </div>
        </div>

        <div class="vs-badge">VS</div>

        <div class="comparison-card @GetCardClass(_state2)" @onclick="() => SelectState(_state2)">
            @if (_hasAnswered && _lastResult?.CorrectAnswer == _state2)
            {
                <span class="correct-indicator">âœ“</span>
            }
            <div class="card-content">
                <div class="state-abbrev">@_state2.Abbreviation</div>
                <h4 class="state-name">@_state2.Name</h4>
                @if (_hasAnswered)
                {
                    <p class="stat-reveal">@_currentQuestion.GetFormattedValue(_state2)</p>
                }
            </div>
        </div>
    </div>

    @if (_hasAnswered && _lastResult is not null)
    {
        <div class="result-section text-center mt-3">
            <div class="alert @(_lastResult.IsCorrect ? "alert-success" : "alert-danger") py-2 mb-2">
                @if (_lastResult.IsCorrect)
                {
                    <strong>âœ“ Correct!</strong>
                }
                else
                {
                    <strong>âœ— Wrong!</strong>
                    <span>@_lastResult.CorrectAnswer.Name was correct.</span>
                }
            </div>
            <button class="btn btn-primary" @onclick="StartNewRound">Next Question â†’</button>
        </div>
    }
}

<div class="question-buttons mt-3">
    <small class="text-muted d-block mb-2">Question Type:</small>
    <div class="btn-group btn-group-sm flex-wrap" role="group">
        <button class="btn @(_randomMode ? "btn-primary" : "btn-outline-primary")" @onclick="ToggleRandomMode">
            ğŸ² Random
        </button>
        @foreach (var q in ComparisonService.AvailableQuestions)
        {
            <button class="btn @(!_randomMode && _currentQuestion?.Id == q.Id ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => SetQuestion(q)">
                @GetShortQuestionName(q.Id)
            </button>
        }
    </div>
</div>

@if (_persistedStats != null)
{
    <div class="lifetime-stats mt-3">
        <small class="text-muted">
            Lifetime: @_persistedStats.TotalCorrect/@_persistedStats.TotalQuestions
            (@(_persistedStats.TotalQuestions > 0 ? $"{(double)_persistedStats.TotalCorrect / _persistedStats.TotalQuestions:P0}" : "N/A"))
            | Best Streak: @_persistedStats.BestStreak
            <button class="btn btn-link btn-sm p-0 ms-2" @onclick="ClearPersistedStats">Clear</button>
        </small>
    </div>
}

@code {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOCAL STORAGE KEY - NAMESPACED FOR THIS COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private const string LocalStorageKey = "HelloAspDotnetTen.StateCompare.Stats";

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPENTELEMETRY INSTRUMENTATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private static readonly ActivitySource ActivitySource = new("BlazorApp.StateCompare", "1.0.0");
    private static readonly Meter Meter = new("BlazorApp.StateCompare", "1.0.0");

    private static readonly Counter<long> RoundCounter = Meter.CreateCounter<long>(
        "statecompare.rounds", unit: "{rounds}", description: "Total rounds started");
    private static readonly Counter<long> AnswerCounter = Meter.CreateCounter<long>(
        "statecompare.answers", unit: "{answers}", description: "Total answers given");
    private static readonly Counter<long> CorrectAnswerCounter = Meter.CreateCounter<long>(
        "statecompare.correct_answers", unit: "{answers}", description: "Total correct answers");
    private static readonly Counter<long> WrongAnswerCounter = Meter.CreateCounter<long>(
        "statecompare.wrong_answers", unit: "{answers}", description: "Total wrong answers");
    private static readonly Counter<long> ResetCounter = Meter.CreateCounter<long>(
        "statecompare.resets", unit: "{resets}", description: "Total game resets");
    private static readonly Counter<long> QuestionTypeChangeCounter = Meter.CreateCounter<long>(
        "statecompare.question_type_changes", unit: "{changes}", description: "Question type changes");
    private static readonly Counter<long> TieSkipCounter = Meter.CreateCounter<long>(
        "statecompare.tie_skips", unit: "{skips}", description: "Pairs skipped due to equal values");
    private static readonly Counter<long> LocalStorageLoadCounter = Meter.CreateCounter<long>(
        "statecompare.localstorage_loads", unit: "{loads}", description: "Local storage loads");
    private static readonly Counter<long> LocalStorageSaveCounter = Meter.CreateCounter<long>(
        "statecompare.localstorage_saves", unit: "{saves}", description: "Local storage saves");

    private static readonly Histogram<int> StreakHistogram = Meter.CreateHistogram<int>(
        "statecompare.streak_length", unit: "{streak}", description: "Streak lengths when broken");
    private static readonly UpDownCounter<int> CurrentScoreGauge = Meter.CreateUpDownCounter<int>(
        "statecompare.current_score", unit: "{score}", description: "Current session score");
    private static readonly UpDownCounter<int> CurrentStreakGauge = Meter.CreateUpDownCounter<int>(
        "statecompare.current_streak", unit: "{streak}", description: "Current streak");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPONENT STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private StateData? _state1;
    private StateData? _state2;
    private ComparisonQuestion? _currentQuestion;
    private ComparisonResult? _lastResult;
    private bool _hasAnswered;
    private bool _randomMode = true;

    // Local storage state
    private ComparePersistedStats? _persistedStats;
    private bool _isJsRuntimeAvailable = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERSISTED STATS MODEL (shared pattern for StateCompare/CountryCompare)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private class ComparePersistedStats
    {
        public int TotalQuestions { get; set; }
        public int TotalCorrect { get; set; }
        public int BestStreak { get; set; }
        public DateTime FirstPlayedUtc { get; set; } = DateTime.UtcNow;
        public DateTime LastPlayedUtc { get; set; } = DateTime.UtcNow;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LIFECYCLE METHODS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    protected override void OnInitialized()
    {
        using var activity = ActivitySource.StartActivity("StateCompare.Initialize");
        Logger.LogInformation("State Comparison Game initialized");
        StartNewRound();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isJsRuntimeAvailable = true;
            await LoadPersistedStatsAsync();
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Save final stats on dispose
        if (_persistedStats != null && ComparisonService.Score.BestStreak > _persistedStats.BestStreak)
        {
            _persistedStats.BestStreak = ComparisonService.Score.BestStreak;
            await SavePersistedStatsAsync();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOCAL STORAGE OPERATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private async Task LoadPersistedStatsAsync()
    {
        using var activity = ActivitySource.StartActivity("StateCompare.LoadPersistedStats");

        try
        {
            var json = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", LocalStorageKey);

            if (!string.IsNullOrEmpty(json))
            {
                _persistedStats = JsonSerializer.Deserialize<ComparePersistedStats>(json);
                LocalStorageLoadCounter.Add(1, new KeyValuePair<string, object?>("storage.found", true));
                Logger.LogInformation("Loaded StateCompare stats: {Total} questions, {Correct} correct",
                    _persistedStats?.TotalQuestions ?? 0, _persistedStats?.TotalCorrect ?? 0);
            }
            else
            {
                _persistedStats = new ComparePersistedStats();
                await SavePersistedStatsAsync();
                LocalStorageLoadCounter.Add(1, new KeyValuePair<string, object?>("storage.found", false));
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load StateCompare persisted stats");
            _persistedStats = new ComparePersistedStats();
        }
    }

    private async Task SavePersistedStatsAsync()
    {
        if (!_isJsRuntimeAvailable || _persistedStats == null) return;

        try
        {
            _persistedStats.LastPlayedUtc = DateTime.UtcNow;
            var json = JsonSerializer.Serialize(_persistedStats);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", LocalStorageKey, json);
            LocalStorageSaveCounter.Add(1);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to save StateCompare persisted stats");
        }
    }

    private async Task ClearPersistedStats()
    {
        using var activity = ActivitySource.StartActivity("StateCompare.ClearPersistedStats");

        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", LocalStorageKey);
            _persistedStats = new ComparePersistedStats();
            Logger.LogInformation("Cleared StateCompare persisted stats");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to clear StateCompare persisted stats");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private void StartNewRound()
    {
        using var activity = ActivitySource.StartActivity("StateCompare.StartNewRound");

        if (_randomMode)
        {
            _currentQuestion = ComparisonService.GetRandomQuestion();
        }
        else
        {
            _currentQuestion ??= ComparisonService.AvailableQuestions[0];
        }

        // Get a pair where values are NOT equal (no ties)
        var pair = ComparisonService.GetRandomStatePairWithoutTie(_currentQuestion);
        if (pair == null)
        {
            // Fallback if somehow no valid pairs exist
            (_state1, _state2) = ComparisonService.GetRandomStatePair();
            TieSkipCounter.Add(1);
        }
        else
        {
            (_state1, _state2) = pair.Value;
        }

        _hasAnswered = false;
        _lastResult = null;

        RoundCounter.Add(1);

        activity?.SetTag("state1.name", _state1?.Name);
        activity?.SetTag("state2.name", _state2?.Name);
        activity?.SetTag("question.type", _currentQuestion?.Id);

        Logger.LogInformation("New round: {State1} vs {State2}, Question: {QuestionType}",
            _state1?.Name, _state2?.Name, _currentQuestion?.Id);
    }

    private async Task SelectState(StateData selectedState)
    {
        if (_hasAnswered || _currentQuestion is null || _state1 is null || _state2 is null)
            return;

        using var activity = ActivitySource.StartActivity("StateCompare.SelectState");

        var previousStreak = ComparisonService.Score.CurrentStreak;
        _lastResult = ComparisonService.CheckAnswer(_state1, _state2, _currentQuestion, selectedState);
        _hasAnswered = true;

        AnswerCounter.Add(1, new KeyValuePair<string, object?>("question.type", _currentQuestion.Id));

        if (_lastResult.IsCorrect)
        {
            CorrectAnswerCounter.Add(1);
            CurrentScoreGauge.Add(1);
            CurrentStreakGauge.Add(1);

            // Update persisted stats
            if (_persistedStats != null)
            {
                _persistedStats.TotalQuestions++;
                _persistedStats.TotalCorrect++;
                if (ComparisonService.Score.CurrentStreak > _persistedStats.BestStreak)
                    _persistedStats.BestStreak = ComparisonService.Score.CurrentStreak;
                await SavePersistedStatsAsync();
            }
        }
        else
        {
            WrongAnswerCounter.Add(1);
            if (previousStreak > 0)
            {
                StreakHistogram.Record(previousStreak);
                CurrentStreakGauge.Add(-previousStreak);
            }

            if (_persistedStats != null)
            {
                _persistedStats.TotalQuestions++;
                await SavePersistedStatsAsync();
            }
        }

        activity?.SetTag("result", _lastResult.IsCorrect ? "correct" : "wrong");
    }

    private void ResetGame()
    {
        using var activity = ActivitySource.StartActivity("StateCompare.ResetGame");

        var finalScore = ComparisonService.Score.CorrectAnswers;
        var bestStreak = ComparisonService.Score.BestStreak;

        CurrentScoreGauge.Add(-finalScore);
        CurrentStreakGauge.Add(-ComparisonService.Score.CurrentStreak);

        ComparisonService.Score.Reset();
        ResetCounter.Add(1);

        activity?.SetTag("final.score", finalScore);
        activity?.SetTag("final.best_streak", bestStreak);

        Logger.LogInformation("Game reset. Final score: {Score}, Best streak: {BestStreak}", finalScore, bestStreak);

        StartNewRound();
    }

    private void SetQuestion(ComparisonQuestion question)
    {
        using var activity = ActivitySource.StartActivity("StateCompare.SetQuestion");

        _randomMode = false;
        _currentQuestion = question;
        QuestionTypeChangeCounter.Add(1);

        StartNewRound();
    }

    private void ToggleRandomMode()
    {
        _randomMode = true;
        StartNewRound();
    }

    private string GetCardClass(StateData state)
    {
        if (!_hasAnswered) return "clickable";
        if (_lastResult is null) return "";

        if (state == _lastResult.CorrectAnswer)
            return "correct-answer";
        if (state == _lastResult.UserChoice && !_lastResult.IsCorrect)
            return "wrong-answer";
        return "";
    }

    private string GetShortQuestionName(string id) => id switch
    {
        "area" => "Area",
        "population" => "Population",
        "representatives" => "House Reps",
        _ => id
    };
}
